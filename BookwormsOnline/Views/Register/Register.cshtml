@model BookwormsOnline.Models.ViewModels.RegisterViewModel
@inject IConfiguration Configuration

@{
    ViewData["Title"] = "Register";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-9">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Membership Registration</h2>

                    <form id="registerForm" asp-action="Register" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <div class="row mb-3">
                            <div class="col">
                                <label asp-for="FirstName" class="form-label">First Name</label>
                                <input asp-for="FirstName" class="form-control" maxlength="50" required />
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>
                            <div class="col">
                                <label asp-for="LastName" class="form-label">Last Name</label>
                                <input asp-for="LastName" class="form-control" maxlength="50" required />
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Email" class="form-label">Email</label>
                            <input asp-for="Email" type="email" class="form-control" maxlength="100" required />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Password" class="form-label">Password</label>
                            <input asp-for="Password" type="password" class="form-control" id="Password" minlength="12" required />
                            <span asp-validation-for="Password" class="text-danger"></span>

                            <ul>
                                <li id="ruleLength">Minimum 12 characters</li>
                                <li id="ruleLower">At least 1 lowercase letter</li>
                                <li id="ruleUpper">At least 1 uppercase letter</li>
                                <li id="ruleNumber">At least 1 number</li>
                                <li id="ruleSpecial">At least 1 special character</li>
                            </ul>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ConfirmPassword" class="form-label">Confirm Password</label>
                            <input asp-for="ConfirmPassword" type="password" class="form-control" required />
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>

                        <div class="row mb-3">
                            <div class="col">
                                <label asp-for="CreditCardNo" class="form-label">Credit Card No</label>
                                <input asp-for="CreditCardNo" class="form-control" maxlength="16" pattern="\d{13,16}" title="Enter 13-16 digits" required />
                                <span asp-validation-for="CreditCardNo" class="text-danger"></span>
                            </div>
                            <div class="col">
                                <label asp-for="MobileNo" class="form-label">Mobile No</label>
                                <input asp-for="MobileNo" class="form-control" pattern="^\+?\d{7,15}$" title="Enter 7-15 digits. Can start with + for country code." required />
                                <span asp-validation-for="MobileNo" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="BillingAddress" class="form-label">Billing Address</label>
                            <textarea asp-for="BillingAddress" class="form-control" maxlength="200" rows="2" required ></textarea>
                            <span asp-validation-for="BillingAddress" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ShippingAddress" class="form-label">Shipping Address</label>
                            <textarea asp-for="ShippingAddress" class="form-control" maxlength="200" rows="2" required ></textarea>
                            <span asp-validation-for="ShippingAddress" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-4">
                            <label asp-for="Photo" class="form-label">Photo (.JPG only)</label>
                            <input asp-for="Photo" type="file" accept=".jpg,.jpeg" data-max-size="@ViewData["MaxPhotoSize"]" class="form-control" required />
                            <span asp-validation-for="Photo" class="text-danger"></span>
                        </div>


                        <input type="hidden" id="recaptchaToken" name="RecaptchaToken" />

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill" id="registerBtn">Register</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const passwordInput = document.getElementById("Password");
            const rules = {
                length: document.getElementById("ruleLength"),
                lower: document.getElementById("ruleLower"),
                upper: document.getElementById("ruleUpper"),
                number: document.getElementById("ruleNumber"),
                special: document.getElementById("ruleSpecial")
            };

            function checkPassword(value) {
                rules.length.style.color = value.length >= 12 ? "green" : "red";
                rules.lower.style.color = /[a-z]/.test(value) ? "green" : "red";
                rules.upper.style.color = /[A-Z]/.test(value) ? "green" : "red";
                rules.number.style.color = /\d/.test(value) ? "green" : "red";
                rules.special.style.color = /[\W_]/.test(value) ? "green" : "red";
            }

            passwordInput.addEventListener("input", () => checkPassword(passwordInput.value));

            const photoInput = document.getElementById("Photo");
            photoInput.addEventListener("change", function () {
                const maxSize = parseInt(photoInput.dataset.maxSize);
                const validationSpan = document.querySelector("span[asp-validation-for='Photo']");
                if (photoInput.files.length > 0) {
                    const file = photoInput.files[0];
                    if (file.size > maxSize) {
                        validationSpan.textContent = `Photo cannot exceed ${maxSize / (1024 * 1024)} MB.`;
                        photoInput.value = "";
                    } else {
                        validationSpan.textContent = "";
                    }
                }
            });
        });

        const siteKey = "@Configuration["GoogleReCaptcha:SiteKey"]";
        document.getElementById("registerForm").addEventListener("submit", function (e) {
            e.preventDefault();
            grecaptcha.ready(() => {
                grecaptcha.execute(siteKey, { action: 'register' }).then(token => {
                    document.getElementById('recaptchaToken').value = token;
                    e.target.submit();
                });
            });
        });
    </script>

    <script src="https://www.google.com/recaptcha/api.js?render=@Configuration["GoogleReCaptcha:SiteKey"]"></script>
}