@model BookwormsOnline.Models.ViewModels.RegisterViewModel
@inject IConfiguration Configuration

@{
    ViewData["Title"] = "Register";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-9">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Create Account</h2>

                    <form id="registerForm" asp-action="Register" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <div class="row mb-3">
                            <div class="col">
                                <label asp-for="FirstName" class="form-label">First Name</label>
                                <input asp-for="FirstName" class="form-control" maxlength="50" required />
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>
                            <div class="col">
                                <label asp-for="LastName" class="form-label">Last Name</label>
                                <input asp-for="LastName" class="form-control" maxlength="50" required />
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Email" class="form-label">Email</label>
                            <input asp-for="Email" type="email" class="form-control" maxlength="100" required />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Password" class="form-label">Password</label>
                            <input asp-for="Password" type="password" class="form-control" id="Password" minlength="12" required />
                            <span asp-validation-for="Password" class="text-danger"></span>

                            <div class="mt-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Password strength:</small>
                                    <small id="strengthLabel" class="fw-semibold text-danger">Very Weak</small>
                                </div>

                                <div class="progress" style="height: 8px;">
                                    <div id="strengthBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>

                                <small id="strengthHint" class="text-muted d-block mt-1">
                                    Use 12+ chars with upper, lower, number, and special.
                                </small>
                            </div>

                            <ul>
                                <li id="ruleLength">Minimum 12 characters</li>
                                <li id="ruleLower">At least 1 lowercase letter</li>
                                <li id="ruleUpper">At least 1 uppercase letter</li>
                                <li id="ruleNumber">At least 1 number</li>
                                <li id="ruleSpecial">At least 1 special character</li>
                            </ul>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ConfirmPassword" class="form-label">Confirm Password</label>
                            <input asp-for="ConfirmPassword" type="password" class="form-control" required />
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>

                        <div class="row mb-3">
                            <div class="col">
                                <label asp-for="CreditCardNo" class="form-label">Credit Card No</label>
                                <input asp-for="CreditCardNo" class="form-control" maxlength="16" pattern="\d{13,16}" title="Enter 13-16 digits" required />
                                <span asp-validation-for="CreditCardNo" class="text-danger"></span>
                            </div>
                            <div class="col">
                                <label asp-for="MobileNo" class="form-label">Mobile No</label>
                                <input asp-for="MobileNo" class="form-control" pattern="^\+?\d{7,15}$" title="Enter 7-15 digits. Can start with + for country code." required />
                                <span asp-validation-for="MobileNo" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="BillingAddress" class="form-label">Billing Address</label>
                            <textarea asp-for="BillingAddress" class="form-control" maxlength="200" rows="2" required ></textarea>
                            <span asp-validation-for="BillingAddress" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ShippingAddress" class="form-label">Shipping Address</label>
                            <textarea asp-for="ShippingAddress" class="form-control" maxlength="200" rows="2" required ></textarea>
                            <span asp-validation-for="ShippingAddress" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-4">
                            <label asp-for="Photo" class="form-label">Photo (.JPG only)</label>
                            <input asp-for="Photo" type="file" accept=".jpg,.jpeg" data-max-size="@ViewData["MaxPhotoSize"]" class="form-control" required />
                            <span asp-validation-for="Photo" class="text-danger"></span>
                        </div>


                        <input type="hidden" id="recaptchaToken" name="RecaptchaToken" />

                        <div class="d-grid">
                            <button type="submit" class="btn btn-dark rounded-pill" id="registerBtn">Register</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const passwordInput = document.getElementById("Password");
            const rules = {
                length: document.getElementById("ruleLength"),
                lower: document.getElementById("ruleLower"),
                upper: document.getElementById("ruleUpper"),
                number: document.getElementById("ruleNumber"),
                special: document.getElementById("ruleSpecial")
            };

            function checkPassword(value) {
            const hasLength = value.length >= 12;
            const hasLower = /[a-z]/.test(value);
            const hasUpper = /[A-Z]/.test(value);
            const hasNumber = /\d/.test(value);
            const hasSpecial = /[\W_]/.test(value);

            rules.length.style.color = hasLength ? "green" : "red";
            rules.lower.style.color = hasLower ? "green" : "red";
            rules.upper.style.color = hasUpper ? "green" : "red";
            rules.number.style.color = hasNumber ? "green" : "red";
            rules.special.style.color = hasSpecial ? "green" : "red";

            let score = 0;
            if (hasLength) score++;
            if (hasLower) score++;
            if (hasUpper) score++;
            if (hasNumber) score++;
            if (hasSpecial) score++;

            const strengthBar = document.getElementById("strengthBar");
            const strengthLabel = document.getElementById("strengthLabel");
            const strengthHint = document.getElementById("strengthHint");

            const percent = (score / 5) * 100;
            strengthBar.style.width = percent + "%";

            let label = "Very Weak";
            let barClass = "bg-danger";
            let hint = "Use 12+ chars with upper, lower, number, and special.";

            if (score <= 1) {
                label = "Very Weak";
                barClass = "bg-danger";
                hint = "Add more character types and make it at least 12 characters.";
            } else if (score === 2) {
                label = "Weak";
                barClass = "bg-danger";
                hint = "Good start—add 2-3 more character types.";
            } else if (score === 3) {
                label = "Medium";
                barClass = "bg-warning";
                hint = "Add another type (number/special/upper/lower) to strengthen it.";
            } else if (score === 4) {
                label = "Strong";
                barClass = "bg-success";
                hint = "Almost perfect—meet all rules for best strength.";
            } else if (score === 5) {
                label = "Very Strong";
                barClass = "bg-success";
                hint = "Nice—meets all your password rules.";
            }

            strengthBar.classList.remove("bg-danger", "bg-warning", "bg-success");
            strengthBar.classList.add(barClass);

            strengthLabel.classList.remove("text-danger", "text-warning", "text-success");
            if (score <= 2) strengthLabel.classList.add("text-danger");
            else if (score === 3) strengthLabel.classList.add("text-warning");
            else strengthLabel.classList.add("text-success");

            strengthLabel.textContent = label;
            strengthHint.textContent = hint;
        }

            passwordInput.addEventListener("input", () => checkPassword(passwordInput.value));

            const photoInput = document.getElementById("Photo");
            photoInput.addEventListener("change", function () {
                const maxSize = parseInt(photoInput.dataset.maxSize);
                const validationSpan = document.querySelector("span[asp-validation-for='Photo']");
                if (photoInput.files.length > 0) {
                    const file = photoInput.files[0];
                    if (file.size > maxSize) {
                        validationSpan.textContent = `Photo cannot exceed ${maxSize / (1024 * 1024)} MB.`;
                        photoInput.value = "";
                    } else {
                        validationSpan.textContent = "";
                    }
                }
            });
        });

        const siteKey = "@Configuration["GoogleReCaptcha:SiteKey"]";
        document.getElementById("registerForm").addEventListener("submit", function (e) {
            e.preventDefault();
            grecaptcha.ready(() => {
                grecaptcha.execute(siteKey, { action: 'register' }).then(token => {
                    document.getElementById('recaptchaToken').value = token;
                    e.target.submit();
                });
            });
        });
    </script>

    <script src="https://www.google.com/recaptcha/api.js?render=@Configuration["GoogleReCaptcha:SiteKey"]"></script>
}