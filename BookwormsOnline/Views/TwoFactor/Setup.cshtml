@{
    ViewData["Title"] = "Two-Factor Authentication Setup";
}

<h2>Two-Factor Authentication</h2>

<p>
    Use the button below to enable or disable Two-Factor Authentication (2FA) for your account.
</p>

@* QR Code and Key *@
<div id="qrSection" class="mb-3" style="display:none;">
    <img id="qrImage" src="" alt="QR Code" class="mb-2" style="max-width: 200px;" />
    <p><strong>Manual key:</strong> <code id="secretKey"></code></p>

    <div class="mt-2">
        <input type="text" id="totpCode" class="form-control" placeholder="Enter 6-digit code" maxlength="6" />
        <button id="verify2FAButton" class="btn btn-success mt-2">Verify Code</button>
    </div>
</div>

<button id="toggle2FAButton" class="btn">
    Loading...
</button>

<div id="feedback" class="mt-3"></div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
        $(document).ready(function () {
            var btn = $("#toggle2FAButton");
            var qrSection = $("#qrSection");
            var qrImage = $("#qrImage");
            var secretKey = $("#secretKey");
            var feedback = $("#feedback");

            // Fetch current 2FA state
            function updateButton(isEnabled) {
                if (isEnabled) {
                    btn.removeClass("btn-success").addClass("btn-danger").text("Disable 2FA");
                    qrSection.hide();
                } else {
                    btn.removeClass("btn-danger").addClass("btn-success").text("Enable 2FA");
                }
            }

            // Initial state
            $.getJSON("@Url.Action("Status", "TwoFactor")", function (data) {
                if (data.success) {
                    updateButton(data.isEnabled);
                } else {
                    btn.text("Error fetching status").prop("disabled", true);
                }
            });

            // Toggle click
            btn.click(function () {
                $.post("@Url.Action("Toggle", "TwoFactor")").done(function (res) {
                    if (res.requiresVerification) {
                        // Show QR and secret for user to scan
                        qrImage.attr("src", res.qrCode);
                        secretKey.text(res.secret);
                        qrSection.show();
                        btn.hide();
                        feedback.html('<div class="alert alert-info">Scan the QR code and enter a 6-digit code from your authenticator.</div>');
                    } else {
                        updateButton(res.isEnabled);
                        qrSection.hide();
                        btn.show();
                        feedback.html('<div class="alert alert-success">2FA status updated!</div>');
                    }
                }).fail(function () {
                    feedback.html('<div class="alert alert-danger">Error toggling 2FA. Try again.</div>');
                });
            });

            // Verify code
            $("#verify2FAButton").click(function (e) {
                e.preventDefault();
                var code = $("#totpCode").val();

                $.post("@Url.Action("VerifyToggle", "TwoFactor")", { code: code }).done(function (res) {
                    if (res.success) {
                        updateButton(res.isEnabled);
                        qrSection.hide();
                        btn.show();
                        feedback.html('<div class="alert alert-success">' + res.message + '</div>');
                    } else {
                        feedback.html('<div class="alert alert-danger">' + res.message + '</div>');
                    }
                }).fail(function () {
                    feedback.html('<div class="alert alert-danger">Error verifying code. Try again.</div>');
                });
            });
        });
    </script>
}